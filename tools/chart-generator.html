<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>折線圖繪製工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        select, input, button, textarea { margin: 10px 0; padding: 5px; }
        #chartContainer { margin-top: 20px; width: 100%; height: 400px; }
        #dataInput { width: 100%; height: 150px; }
    </style>
</head>
<body>
    <h1>折線圖繪製工具</h1>
    <div>
        <label for="dataInput">輸入座標：</label>
        <textarea id="dataInput" aria-label="座標輸入" placeholder="請輸入座標，每行一個點，格式：X,Y&#10;例如：&#10;45,0&#10;55,2&#10;65,3&#10;75,4&#10;85,6&#10;95,2"></textarea>
    </div>
    <div>
        <label for="chartTitle">圖表標題：</label>
        <input type="text" id="chartTitle" aria-label="圖表標題">
    </div>
    <div>
        <label for="xAxisLabel">X軸標籤（包含單位）：</label>
        <input type="text" id="xAxisLabel" aria-label="X軸標籤" placeholder="例如：時間 (秒)">
    </div>
    <div>
        <label for="yAxisLabel">Y軸標籤（包含單位）：</label>
        <input type="text" id="yAxisLabel" aria-label="Y軸標籤" placeholder="例如：溫度 (°C)">
    </div>
    <button onclick="drawChart()" aria-label="繪製圖表">繪製圖表</button>
    <button onclick="saveChart()" aria-label="保存圖表">保存圖表</button>
    <button onclick="saveChartAndData()" aria-label="保存圖表和數據">保存圖表和數據</button>
    <input type="file" id="fileInput" accept=".csv" aria-label="上傳 CSV 文件" style="display:none;">
    <button onclick="document.getElementById('fileInput').click()" aria-label="上傳數據">上傳數據</button>
    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        let myChart = null;

        function parseData(input) {
            return input.split('\n').map(line => {
                const [x, y] = line.split(',').map(Number);
                return { x, y };
            });
        }

        function calculateStepSize(min, max) {
            const range = max - min;
            const magnitude = Math.pow(10, Math.floor(Math.log10(range)));
            const residual = range / magnitude;

            if (residual > 5) return magnitude;
            if (residual > 2) return magnitude / 2;
            if (residual > 1) return magnitude / 5;
            return magnitude / 10;
        }

        function roundUpToNearestMultiple(num, multiple) {
            return Math.ceil(num / multiple) * multiple;
        }

        function drawChart() {
            const inputData = parseData(document.getElementById('dataInput').value);
            const chartTitle = document.getElementById('chartTitle').value;
            const xAxisLabel = document.getElementById('xAxisLabel').value;
            const yAxisLabel = document.getElementById('yAxisLabel').value;

            const ctx = document.getElementById('myChart').getContext('2d');

            if (myChart) {
                myChart.destroy();
            }

            // 找出數據的最大和最小值
            const xValues = inputData.map(point => point.x);
            const yValues = inputData.map(point => point.y);
            const xMin = Math.min(0, ...xValues);
            const xMax = Math.max(...xValues);
            const yMin = Math.min(0, ...yValues);
            const yMax = Math.max(...yValues);

            // 計算適合的刻度間隔
            const xStepSize = calculateStepSize(xMin, xMax);
            const yStepSize = calculateStepSize(yMin, yMax);

            // 調整座標軸的最大值，確保比數據最大值大一個刻度單位
            const xAxisMax = roundUpToNearestMultiple(xMax + xStepSize, xStepSize);
            const yAxisMax = roundUpToNearestMultiple(yMax + yStepSize, yStepSize);

            myChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '數據點',
                        data: inputData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgb(75, 192, 192)',
                        showLine: true,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: xAxisLabel
                            },
                            min: xMin,
                            max: xAxisMax,
                            ticks: {
                                stepSize: xStepSize
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel
                            },
                            min: yMin,
                            max: yAxisMax,
                            ticks: {
                                stepSize: yStepSize
                            }
                        }
                    }
                }
            });
        }

        function saveChart() {
            const link = document.createElement('a');
            link.download = 'chart.png';
            link.href = document.getElementById('myChart').toDataURL();
            link.click();
        }

        function saveChartAndData() {
            // 保存圖表
            const chartImage = document.getElementById('myChart').toDataURL();
            
            // 準備數據
            const chartTitle = document.getElementById('chartTitle').value;
            const xAxisLabel = document.getElementById('xAxisLabel').value;
            const yAxisLabel = document.getElementById('yAxisLabel').value;
            const data = document.getElementById('dataInput').value;

            // 創建包含圖表和數據的 HTML
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="zh-Hant">
                <head>
                    <meta charset="UTF-8">
                    <title>${chartTitle}</title>
                </head>
                <body>
                    <h1>${chartTitle}</h1>
                    <img src="${chartImage}" alt="圖表">
                    <h2>數據</h2>
                    <p>X軸: ${xAxisLabel}</p>
                    <p>Y軸: ${yAxisLabel}</p>
                    <pre>${data}</pre>
                </body>
                </html>
            `;

            // 創建 Blob 並下載
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'chart_and_data.html';
            link.click();
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('dataInput').value = e.target.result;
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>