<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTF 編輯器(可插入 LaTeX)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* 原有的 RTF 編輯器樣式 */
        #editor {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 200px;
        }
        .editor-fixed-height {
            height: 300px;
            overflow-y: auto;
        }
        .toolbar {
            margin-bottom: 10px;
        }
        .toolbar button, .toolbar select, .toolbar input {
            margin: 2px;
            padding: 5px;
        }
        .toolbar button i {
            font-size: 16px;
        }
        #findReplacePanel {
            display: none;
            margin-top: 10px;
        }
        /* 數學編輯器模態框樣式 */
        .math-editor-container {
            display: flex;
            width: 90%;
            margin: 10px auto;
        }
        
        #latexInput, #preview {
            flex: 1;
            height: 300px;
            margin: 10px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
        }
        
        .math-toolbar {
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }
        
        .math-toolbar button {
            margin: 1px;
            padding: 2px 4px;
            cursor: pointer;
        }
        
        .math-toolbar button:hover:after {
            content: attr(data-text);
            position: absolute;
            background-color: #333;
            color: #fff;
            padding: 5px;
            border-radius: 5px;
            font-size: 14px;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            z-index: 9999;
        }
        
        /* 模態框樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
		.math-node {
			display: inline-block;
			vertical-align: middle;
			margin: 0 2px;
			padding: 2px;
			border: 1px solid transparent;
			cursor: pointer;
		}

		.math-node:hover {
			border-color: #ccc;
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.4);
		}

		.modal-content {
			background-color: #fefefe;
			margin: 5% auto;
			padding: 20px;
			border: 1px solid #888;
			width: 90%;
			max-width: 1200px;
			position: relative;
		}
    </style>
</head>
<body>
    <!-- 原有的 RTF 編輯器工具列 -->
    <div class="toolbar">
        <button onclick="openFile()"><i class="fas fa-folder-open"></i> 開啟</button>
        <button onclick="saveFile()"><i class="fas fa-save"></i> 儲存</button>
        <select id="headingSelect" onchange="applyHeading(this.value)">
            <option value="">標題級別</option>
            <option value="h1">標題 1</option>
            <option value="h2">標題 2</option>
            <option value="h3">標題 3</option>
            <option value="h4">標題 4</option>
            <option value="h5">標題 5</option>
            <option value="h6">標題 6</option>
            <option value="p">正文</option>
        </select>
        <select onchange="execCmd('fontSize', this.value)">
            <option value="">字號</option>
            <option value="1">小</option>
            <option value="3">正常</option>
            <option value="5">大</option>
            <option value="7">特大</option>
        </select>
        <button onclick="execCmd('bold')"><i class="fas fa-bold"></i></button>
        <button onclick="execCmd('italic')"><i class="fas fa-italic"></i></button>
        <button onclick="execCmd('underline')"><i class="fas fa-underline"></i></button>
        <button onclick="execCmd('foreColor', prompt('輸入顏色（如 #ff0000）:'))"><i class="fas fa-font"></i></button>
        <button onclick="execCmd('hiliteColor', prompt('輸入顏色（如 #ffff00）:'))"><i class="fas fa-fill-drip"></i></button>
        <button onclick="execCmd('justifyLeft')"><i class="fas fa-align-left"></i></button>
        <button onclick="execCmd('justifyCenter')"><i class="fas fa-align-center"></i></button>
        <button onclick="execCmd('justifyRight')"><i class="fas fa-align-right"></i></button>
        <button onclick="execCmd('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
        <button onclick="execCmd('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
        <button onclick="insertTable()"><i class="fas fa-table"></i></button>
        <button onclick="insertLink()"><i class="fas fa-link"></i></button>
		<button onclick="openPresetTextModal()"><i class="fas fa-list-alt"></i> 插入文字</button>
        <button onclick="clearFormatting()"><i class="fas fa-eraser"></i> 清除格式</button>
        <button onclick="formatOptions()"><i class="fas fa-magic"></i> 整理格式</button>
        <button id="toggleFindReplaceBtn"><i class="fas fa-search"></i> 尋找/取代</button>
        <button onclick="preprocessForConversion()"><i class="fas fa-file-export"></i> 轉檔前置</button>
		<button onclick="insertMathEquation()"><i class="fas fa-square-root-alt"></i></button>
    </div>
    <div id="findReplacePanel">
        <input type="text" id="findText" placeholder="尋找">
        <input type="text" id="replaceText" placeholder="取代">
        <button onclick="findNext()">尋找下一個</button>
        <button onclick="replaceNext()">取代</button>
        <button onclick="replaceAll()">全部取代</button>
    </div>
	<div>
        <input type="checkbox" id="fixedHeightToggle">
        <label for="fixedHeightToggle">固定高度模式</label>
    </div>

    <!-- 編輯器主體 -->
    <div id="editor" contenteditable="true"></div>

    <!-- 數學編輯器模態框 -->
    <div id="mathEditorModal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 1200px;">
            <span class="close" onclick="closeMathEditorModal()">&times;</span>
            <h2>數學公式編輯器</h2>
            
            <!-- 整合的數學編輯器工具列 -->
            <div class="math-toolbar">
   <div>
    <a role="navigation">編輯</a>
	<button data-text="切換包覆方式" id="toggleDelimiterButton" onclick="toggleDelimiter()" style="background-color: #ccffcc;">使用 <code>\( \)</code></button>
	<button data-text="插入數學式分隔符" onclick="insertMathDelimiters()">插入數學式</button>
	<button data-text="整理包覆方式" onclick="convertAllDelimiters()">整理</button>
	<a role="navigation">文件</a>
    <input type="file" id="fileInput" accept=".txt" style="display:none" onchange="openFile(event)">
    <button data-text="打開純文字檔" onclick="document.getElementById('fileInput').click()">打開 TXT</button>
    <button data-text="選項斷行、換題空行" onclick="formatOptions()">試卷調整</button>
    <button data-text="取代" onclick="replaceText()">取代</button>
	  <button data-text="MathPix 圖片語法處理" onclick="convertMarkdownToHTML()">MPX</button>
	  <button data-text="去掉大寫間空格" onclick="delspace()">DS</button>
	  <button data-text="注意！無法復原" onclick="clearAll();">清空</button><br>
  	<a role="navigation">運算符號</a>
  	<button data-text="乘號" onclick="insertMath('\\times\ ')">×</button>
	<button data-text="除號" onclick="insertMath('\\div\ ')">÷</button>
	<button data-text="加減/正負" onclick="insertMath('\\pm\ ')">±</button>
  	<a role="navigation">關係符號</a>
	<button data-text="小於等於" onclick="insertMath('\\le\ ')">≤</button>
	<button data-text="大於等於" onclick="insertMath('\\ge\ ')">≥</button>
	<button data-text="不等於" onclick="insertMath('\\ne\ ')">≠</button>
	<button data-text="約等於" onclick="insertMath('\\approx\ ')">≈</button>
	<button data-text="近似於" onclick="insertMath('\\fallingdotseq\ ')">≒</button>
	<button data-text="全等" onclick="insertMath('\\cong\ ')">≅</button>
	<button data-text="相似" onclick="insertMath('\\sim\ ')">∼</button>
	<button data-text="平行" onclick="insertMath('\\parallel\ ')">∥</button>
	<button data-text="垂直" onclick="insertMath('\\perp\ ')">⊥</button>
  	<a role="navigation">希臘字母</a>
  	<select id="select-letter" onchange="insertGreekLetter()">
      <option value="">請選擇</option>
      <option value="">小寫</option>
      <option value="\alpha">α</option>
      <option value="\beta">β</option>
      <option value="\gamma">γ</option>
      <option value="\delta">δ</option>
      <option value="\epsilon">ε</option>
      <option value="\zeta">ζ</option>
      <option value="\eta">η</option>
      <option value="\theta">θ</option>
      <option value="\iota">ι</option>
      <option value="\kappa">κ</option>
      <option value="\lambda">λ</option>
      <option value="\mu">μ</option>
      <option value="\nu">ν</option>
      <option value="\xi">ξ</option>
      <option value="\omicron">ο</option>
      <option value="\pi">π</option>
      <option value="\rho">ρ</option>
      <option value="\sigma">σ</option>
      <option value="\tau">τ</option>
      <option value="\upsilon">υ</option>
      <option value="\phi">φ</option>
      <option value="\chi">χ</option>
      <option value="\psi">ψ</option>
      <option value="\omega">ω</option>
      <option value="">大寫</option>
      <option value="\Alpha">Α</option>
      <option value="\Beta">Β</option>
      <option value="\Gamma">Γ</option>
      <option value="\Delta">Δ</option>
      <option value="\Epsilon">Ε</option>
      <option value="\Zeta">Ζ</option>
      <option value="\Eta">Η</option>
      <option value="\Theta">Θ</option>
      <option value="\Iota">Ι</option>
      <option value="\Kappa">Κ</option>
      <option value="\Lambda">Λ</option>
      <option value="\Mu">Μ</option>
      <option value="\Nu">Ν</option>
      <option value="\Xi">Ξ</option>
      <option value="\Omicron">Ο</option>
      <option value="\Pi">Π</option>
      <option value="\Rho">Ρ</option>
      <option value="\Sigma">Σ</option>
      <option value="\Tau">Τ</option>
      <option value="\Upsilon">Υ</option>
      <option value="\Phi">Φ</option>
      <option value="\Chi">Χ</option>
      <option value="\Psi">Ψ</option>
      <option value="\Omega">Ω</option>
    </select>
	<br>
    <a role="navigation">常用符號</a>	
	<button data-text="因為" onclick="insertMath('\\because\ ')">∵</button>
	<button data-text="所以" onclick="insertMath('\\therefore\ ')">∴</button>
	<button data-text="度" onclick="insertMath('^{\\circ} ')">°</button>
	<button data-text="圓週率" onclick="insertMath('\\pi\ ')">π</button>
	<button data-text="無限" onclick="insertMath('\\infty\ ')">∞</button>
	<button data-text="交集" onclick="insertMath('\\cap\ ')">∩</button>
	<button data-text="聯集" onclick="insertMath('\\cup\ ')">∪</button>
	<button data-text="百分率" onclick="insertMath('\\%\ ')">%</button>
	<button data-text="千分率" onclick="insertMath('‰\ ')">‰</button>
	<button data-text="大括號 { }" onclick="insertMath('\\\{ \\\}')">{ }</button>
	  <select id="set-symbols" onchange="insertSymbols()">
		<option value="">其他符號</option>
		<optgroup label="箭頭符號">
		  <option value="\rightarrow">→ (右箭頭)</option>
		  <option value="\leftarrow">← (左箭頭)</option>
		  <option value="\leftrightarrow">↔ (雙向箭頭)</option>
		  <option value="\Rightarrow">⇒ (雙線右箭頭)</option>
		  <option value="\Leftarrow">⇐ (雙線左箭頭)</option>
		  <option value="\Leftrightarrow">⇔ (雙線雙向箭頭)</option>
		  <option value="\uparrow">↑ (上箭頭)</option>
		  <option value="\downarrow">↓ (下箭頭)</option>
		  <option value="\updownarrow">↕ (上下箭頭)</option>
		  <option value="\mapsto">↦ (映射箭頭)</option>
		  <option value="\longmapsto">⟼ (長映射箭頭)</option>
		  <option value="\rightharpoonup">⇀ (右半箭頭)</option>
		  <option value="\rightharpoondown">⇁ (右半箭頭向下)</option>
		  <option value="\leftharpoonup">↼ (左半箭頭)</option>
		  <option value="\leftharpoondown">↽ (左半箭頭向下)</option>
		</optgroup>
		<optgroup label="集合符號">
		  <option value="\in">∈ (屬於)</option>
		  <option value="\notin">∉ (不屬於)</option>
		  <option value="\ni">∋ (包含)</option>
		  <option value="\subset">⊂ (真子集)</option>
		  <option value="\supset">⊃ (真超集)</option>
		  <option value="\subseteq">⊆ (子集)</option>
		  <option value="\supseteq">⊇ (超集)</option>
		  <option value="\emptyset">∅ (空集)</option>
		  <option value="\forall">∀ (任意)</option>
		  <option value="\exists">∃ (存在)</option>
		</optgroup>
		<optgroup label="數集">
		  <option value="\mathbb{N}">ℕ (自然數集)</option>
		  <option value="\mathbb{Z}">ℤ (整數集)</option>
		  <option value="\mathbb{Q}">ℚ (有理數集)</option>
		  <option value="\mathbb{R}">ℝ (實數集)</option>
		  <option value="\mathbb{C}">ℂ (複數集)</option>
		</optgroup>
		<optgroup label="微積分符號">
		  <option value="\int_{a}^{b} f(x) \,dx">∫ (定積分)</option>
		  <option value="\iint_{D} f(x,y) \,dA">∬ (二重積分)</option>
		  <option value="\iiint_{V} f(x,y,z) \,dV">∭ (三重積分)</option>
		  <option value="\oint_{C} f(z) \,dz">∮ (曲線積分)</option>
		  <option value="\frac{\partial f}{\partial x}">∂ (偏導數)</option>
		  <option value="\nabla f = \left(\frac{\partial f}{\partial x}, \frac{\partial f}{\partial y}, \frac{\partial f}{\partial z}\right)">∇ (梯度)</option>
		  <option value="\lim_{x \to a} f(x)">lim (極限)</option>
		  <option value="\sum_{n=1}^{\infty} a_n">∑ (級數)</option>
		  <option value="\prod_{i=1}^{n} x_i">∏ (連乘)</option>
		  <option value="\frac{d}{dx} f(x)">d/dx (導數)</option>
		  <option value="\int_{-\infty}^{\infty} f(x) \,dx">∞ (無窮積分)</option>
		</optgroup>
	  </select>
  <br>
  	<a role="navigation">幾何</a>
	<button data-text="角 \angle{端點}" onclick="insertMath('\\angle{}')">∠</button>
	<button data-text="三角形 \triangle{頂點}" onclick="insertMath('\\triangle{}')">△</button>
  	<button data-text="線段 \overline{端點}" onclick="insertMath('\\overline{}')">線段</button>
  	<button data-text="射線 \overrightarrow{端點}" onclick="insertMath('\\overrightarrow{}')">射線</button>
  	<button data-text="射線 \overleftrightarrow{端點}" onclick="insertMath('\\overleftrightarrow{}')">直線</button>
  	<button data-text="弧 \overset{\frown}{端點}" onclick="insertMath('\\overset{\\frown}{}')">弧</button>
  	<button data-text="向量 \vec{文字}" onclick="insertMath('\\vec{}')">向量</button>
	<a role="navigation">三角函數</a>
		<select id="select-trig" onchange="insertTrigFunction()">
		  <option value="">請選擇</option>
		  <option value="\sin">sin</option>
		  <option value="\cos">cos</option>
		  <option value="\tan">tan</option>
		  <option value="\csc">csc</option>
		  <option value="\sec">sec</option>
		  <option value="\cot">cot</option>
		  <option value="\arcsin">arcsin</option>
		  <option value="\arccos">arccos</option>
		  <option value="\arctan">arctan</option>
		  <option value="\sinh">sinh</option>
		  <option value="\cosh">cosh</option>
		  <option value="\tanh">tanh</option>
		</select>
    <button data-text="切換同步捲動" id="toggleSyncButton" onclick="toggleSync()" style="background-color: #ccffcc;">同步捲動：開</button>
  	<br>
  	<a role="navigation">層次</a>
  	<button data-text="分數 \frac{分子}{分母}" onclick="insertMath('\\frac{}{}')">分數</button>
  	<button data-text="上標/指數 ^{n}" onclick="insertMath('^{}')">xⁿ</button>
  	<button data-text="下標/底數 _{n}" onclick="insertMath('_{}')">xₙ</button>
  	<button data-text="根號 \sqrt{n}" onclick="insertMath('\\sqrt{}')">√x</button>
  	<button data-text="n 次方根 \sqrt[n]{m}" onclick="insertMath('\\sqrt[n]{}')">n次方根 ∛x</button>
  	<button data-text="聯立方程式 \begin{cases} {第一式} &amp;{註記} \\ {第二式} &amp;{註記} \end{cases}" onclick="insertMath('\\begin{cases} {} &{} \\\\ {} &{} \\end{cases}')">聯立方程式</button>
  	<button data-text="總和 \sum\limits_{起點}^{終點}" onclick="insertMath('\\sum\\limits_{}^{}')">Σ</button>
  	<button data-text="極值 \lim\limits_{{起點} \to {終點}}" onclick="insertMath('\\lim\\limits_{{} \\to {}}')">lim</button>
  	<button data-text="數對 \log_{基數/底}" onclick="insertMath('\\log_{}')">log</button>
  	<button data-text="矩陣 \left [ \begin{matrix} {} &{} \\ {} &{} \end{matrix} \right ]" onclick="insertMath('\\left [ \\begin{matrix} {} &{} \\\\ {} &{} \\end{matrix} \\right ]')">矩陣</button>
  	<button data-text="行列式 \left | \begin{array} {cc} {} &{} \\ {} &{} \end{array} \right |" onclick="insertMath('\\left | \\begin{array} {cc} {} &{} \\\\ {} &{} \\end{array} \\right |')">行列式</button>
  	<button data-text="表格 \begin{array} {cc} {} &{} &{} \\ {} &{} &{} \end{array} " onclick="insertMath('\\begin{array} {} {A} &{B} &{C} \\\\ {1} &{2} &{3} \\end{array}')">表格</button>
	</div>   
            </div>
            
            <!-- 數學編輯器主體 -->
            <div class="math-editor-container">
                <textarea id="latexInput" placeholder="在此輸入含 LaTeX 語法的文本"></textarea>
                <div id="preview"></div>
            </div>
            <div class="mathml-container" style="display: none;">
				<textarea id="mathmlOutput" placeholder="MathML 轉換結果" readonly></textarea>
				<button onclick="saveMathMLOutput()">儲存 MathML</button>
			</div>
            <!-- 數學編輯器操作按鈕 -->
            <div class="math-editor-buttons">
                <button onclick="insertMathFromEditor()">插入</button>
                <button onclick="closeMathEditorModal()">取消</button>
            </div>
        </div>
    </div>

<div id="presetTextModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePresetTextModal()">&times;</span>
        <h2>選擇預設文字</h2>
        <select id="presetTextSelect" style="width: 100%; padding: 5px; margin-bottom: 10px;">
            <option value="">請選擇</option>
            <option value="請參閱附圖">請參閱附圖</option>
            <option value="選項請參閱附圖">選項請參閱附圖</option>
            <option value="此題視障生不作答">此題視障生不作答</option>
            <option value="請參閱紙本試卷">請參閱紙本試卷</option>
        </select>
        <button onclick="insertPresetText()">插入</button>
    </div>
</div>

    <script>
        // 整合兩個編輯器的所有 JavaScript 函數
        function execCmd(command, value = null) {
            document.execCommand(command, false, value);
        }

function insertMathFromEditor() {
    let latex = document.getElementById('latexInput').value.trim();
    if (!latex) {
        closeMathEditorModal();
        return;
    }
    
    // 移除 LaTeX 分隔符
    latex = latex.replace(/^\\\((.*)\\\)$/, '$1')  // 移除 \( \)
                 .replace(/^\$(.*)\$$/, '$1');      // 移除 $ $
    
    // 獲取 editor
    const editor = document.getElementById('editor');
    
    try {
        // 創建數學節點
        const mathSpan = document.createElement('span');
        mathSpan.className = 'math-node';
        mathSpan.setAttribute('contenteditable', 'false');
        mathSpan.setAttribute('data-latex', latex);
        
        // 使用 KaTeX 渲染數學式
        katex.render(latex, mathSpan, {
            throwOnError: false,
            displayMode: false
        });
        
        // 確保有選擇範圍並在編輯器內
        let range;
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            range = selection.getRangeAt(0);
            // 檢查範圍是否在編輯器內
            if (!editor.contains(range.commonAncestorContainer)) {
                range = document.createRange();
                range.selectNodeContents(editor);
                range.collapse(false);
            }
        } else {
            range = document.createRange();
            range.selectNodeContents(editor);
            range.collapse(false);
        }
        
        // 插入數學節點
        range.insertNode(mathSpan);
        
        // 將游標移動到插入的數學式後面
        range = document.createRange();
        range.setStartAfter(mathSpan);
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
        
        // 清空輸入框並關閉模態框
        document.getElementById('latexInput').value = '';
        document.getElementById('preview').innerHTML = '';
        closeMathEditorModal();
        
        // 確保編輯器保持焦點
        editor.focus();
        
    } catch (error) {
        console.error('LaTeX 渲染錯誤:', error);
        alert('LaTeX 語法錯誤，請檢查您的輸入');
    }
}

function handleMathError(error, mathSpan) {
    console.error('Math rendering error:', error);
    mathSpan.textContent = '數學式渲染錯誤';
    mathSpan.style.color = 'red';
    return mathSpan;
}

        function applyHeading(tag) {
            if (tag === 'p') {
                document.execCommand('formatBlock', false, '<p>');
            } else if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tag)) {
                document.execCommand('formatBlock', false, '<' + tag + '>');
            }
            // 在應用標題後更新選擇框
            setTimeout(updateHeadingSelect, 0);
        }

        function insertTable() {
            var rows = prompt('請輸入行數:', '2');
            var cols = prompt('請輸入列數:', '2');
            
            if (rows && cols) {
                var table = '<table border="1" style="border-collapse: collapse;">';
                for (var i = 0; i < rows; i++) {
                    table += '<tr>';
                    for (var j = 0; j < cols; j++) {
                        table += '<td style="width: 50px; height: 20px; padding: 5px;">&nbsp;</td>';
                    }
                    table += '</tr>';
                }
                table += '</table>';
                
                document.execCommand('insertHTML', false, table);
            }
        }

        function insertLink() {
            var url = prompt('請輸入 URL:', 'http://');
            var text = prompt('請輸入連結文字:', '連結');
            if (url && text) {
                var link = '<a href="' + url + '">' + text + '</a>';
                document.execCommand('insertHTML', false, link);
            }
        }

        function clearFormatting() {
            execCmd('removeFormat');
            execCmd('unlink');
            document.execCommand('formatBlock', false, '<p>');
            updateHeadingSelect(); // 更新選擇框
        }
		
		function updateHeadingSelect() {
            var headingSelect = document.getElementById('headingSelect');
            var currentNode = window.getSelection().anchorNode;
            while (currentNode && currentNode.nodeType !== 1) {
                currentNode = currentNode.parentNode;
            }
            if (currentNode) {
                var tagName = currentNode.tagName.toLowerCase();
                if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p'].includes(tagName)) {
                    headingSelect.value = tagName;
                } else {
                    headingSelect.value = '';
                }
            }
        }

        function openFile() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.html, .txt';
            input.onchange = function(e) {
                var file = e.target.files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    if (file.name.endsWith('.txt')) {
                        document.getElementById('editor').innerText = e.target.result;
                    } else {
                        document.getElementById('editor').innerHTML = e.target.result;
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function formatOptions() {
            let editor = document.getElementById('editor');
            let text = editor.innerText;
            
            // 原有的格式化邏輯
            text = text.replace(/\t/g, " ").replace(/　/g, " ").replace(/ {2,}/g, " ").replace(/（/g, '(').replace(/）/g, ')');
            let paragraphs = text.split(/\n\s*/);
            paragraphs = paragraphs.map((paragraph, index) => {
                if (/\([A-Z]\)/.test(paragraph)) {
                    let options = paragraph.split(/(?=\([A-D]\))/);
                    options = options.map(option => option.trim().replace(/^\(([A-D])\)\s*/, "($1) "));
                    return options.join('\n') + '\n';
                }
                return paragraph;
            });
            text = paragraphs.join('\n');
            text = text.replace(/(\([A-D]\)\s[^\n]*)(\n\s*\n(?=\([A-D]\)))/g, '$1\n');
            
            // 處理不正確的斷行
            let lines = text.split('\n');
            let formattedLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                let currentLine = lines[i].trim();
                
                // 如果不是選項且不是空行
                if (!/^\([A-D]\)/.test(currentLine) && currentLine !== '') {
                    // 檢查是否需要與下一行合併
                    while (i < lines.length - 1 && 
                           !/[。？！」：]\s*$/.test(currentLine) && 
                           !/^\([A-D]\)/.test(lines[i+1]) &&
                           lines[i+1].trim() !== '') {
                        // 如果當前行不是以結束性標點結尾，且下一行不是選項也不是空行，則合併
                        // 直接合併，不添加空格
                        currentLine = currentLine + lines[i+1].trim();
                        i++; // 跳過下一行，因為已經合併了
                    }
                }
                
                formattedLines.push(currentLine);
            }
            
            // 重新組合文本
            text = formattedLines.join('\n');
            
            // 將格式化後的文本重新插入編輯器
            editor.innerHTML = text.trim().replace(/\n/g, '<br>');
        }

        document.addEventListener('DOMContentLoaded', function() {
            var toggleBtn = document.getElementById('toggleFindReplaceBtn');
            var panel = document.getElementById('findReplacePanel');
            var editor = document.getElementById('editor');
            var headingSelect = document.getElementById('headingSelect');
            var fixedHeightToggle = document.getElementById('fixedHeightToggle');
			
			editor.addEventListener('click', updateHeadingSelect);
            editor.addEventListener('keyup', updateHeadingSelect);
            
            toggleBtn.addEventListener('click', function() {
                if (panel.style.display === 'none' || panel.style.display === '') {
                    panel.style.display = 'block';
                } else {
                    panel.style.display = 'none';
                }
            });

            fixedHeightToggle.addEventListener('change', function() {
                if (this.checked) {
                    editor.classList.add('editor-fixed-height');
                } else {
                    editor.classList.remove('editor-fixed-height');
                }
            });
        });

        function findNext() {
            var findText = document.getElementById('findText').value;
            var editor = document.getElementById('editor');
            
            // 移除之前的高亮
            removeHighlights();

            var found = window.find(findText, false, false, true, false, true, false);
            
            if (found) {
                highlightSelection();
                scrollToHighlight();
            } else {
                alert('找不到匹配項');
            }
        }

        function replaceNext() {
            var findText = document.getElementById('findText').value;
            var replaceText = document.getElementById('replaceText').value;
            var selection = window.getSelection();

            if (selection.toString() === findText) {
                var range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(replaceText));
                findNext();
            } else {
                findNext();
            }
        }

        function replaceAll() {
            var findText = document.getElementById('findText').value;
            var replaceText = document.getElementById('replaceText').value;
            var editor = document.getElementById('editor');
            var content = editor.innerHTML;
            
            // 使用正則表達式進行全局替換
            var regex = new RegExp(escapeRegExp(findText), 'g');
            content = content.replace(regex, replaceText);
            
            editor.innerHTML = content;
        }

        function highlightSelection() {
            var range = window.getSelection().getRangeAt(0);
            var span = document.createElement('span');
            span.className = 'highlight';
            range.surroundContents(span);
        }

        function removeHighlights() {
            var editor = document.getElementById('editor');
            var highlights = editor.getElementsByClassName('highlight');
            while (highlights.length) {
                var parent = highlights[0].parentNode;
                while (highlights[0].firstChild) {
                    parent.insertBefore(highlights[0].firstChild, highlights[0]);
                }
                parent.removeChild(highlights[0]);
            }
        }

        function scrollToHighlight() {
            var editor = document.getElementById('editor');
            var highlight = editor.getElementsByClassName('highlight')[0];
            if (highlight) {
                highlight.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
            }
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function preprocessForConversion() {
            let editor = document.getElementById('editor');
            let text = editor.innerText;
            let lines = text.split('\n');
            let formattedLines = [];
            let isInOptions = false;
            for (let i = 0; i < lines.length; i++) {
                let currentLine = lines[i].trim();
                // 檢查是否是選項
                if (/^\([A-D]\)/.test(currentLine)) {
                    if (!isInOptions) {
                        // 如果是新的選項組，先添加兩個空行（除非是文本的開始）
                        if (formattedLines.length > 0) {
                            formattedLines.push('', '');
                        }
                        isInOptions = true;
                    }
                    formattedLines.push(currentLine);
                } else if (currentLine !== '') {
                    // 如果不是選項且不是空行，認為是新的題目
                    if (isInOptions) {
                        // 如果之前是選項，現在是新題目，添加兩個空行
                        formattedLines.push('', '');
                        isInOptions = false;
                    } else if (formattedLines.length > 0) {
                        // 如果之前不是選項，但也不是文本開始，也添加兩個空行
                        formattedLines.push('', '');
                    }
                    formattedLines.push(currentLine);
                }
            }
            // 重新組合文本
            text = formattedLines.join('\n');
            editor.innerHTML = text.trim().replace(/\n/g, '<br>');
        }
		
        function openPresetTextModal() {
            document.getElementById('presetTextModal').style.display = 'block';
        }

        function closePresetTextModal() {
            document.getElementById('presetTextModal').style.display = 'none';
        }

        function insertPresetText() {
            var select = document.getElementById('presetTextSelect');
            var text = select.value;
            if (text) {
                var editor = document.getElementById('editor');
                var selection = window.getSelection();
                var range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(text));
                closePresetTextModal();
            }
        }

        // 當用戶點擊模態框外部時關閉它
        window.onclick = function(event) {
            var modal = document.getElementById('presetTextModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

function insertMathEquation() {
    // 不要直接創建 input，而是開啟數學編輯器模態框
    document.getElementById('mathEditorModal').style.display = 'block';
    
    // 清空並聚焦 latex 輸入框
    const latexInput = document.getElementById('latexInput');
    latexInput.value = '';
    latexInput.focus();
    
    // 清空預覽區
    document.getElementById('preview').innerHTML = '';
}

        function finishMathInput(inputElement) {
            var mathSpan = inputElement.parentNode;
            var latex = inputElement.value.trim();
            if (latex) {
                mathSpan.setAttribute('data-latex', latex);
                renderMathInElement(mathSpan, latex);
                // 將游標移動到數學式後方
                var range = document.createRange();
                var sel = window.getSelection();
                range.setStartAfter(mathSpan);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
                // 確保編輯器獲得焦點
                document.getElementById('editor').focus();
            } else {
                mathSpan.parentNode.removeChild(mathSpan);
            }
        }

        function renderMathInElement(element, latex) {
            katex.render(latex, element, {
                throwOnError: false,
                displayMode: false
            });
        }

        function editMathNode(mathNode) {
            var latex = mathNode.getAttribute('data-latex');
            mathNode.innerHTML = '';
            var input = document.createElement('input');
            input.type = 'text';
            input.className = 'math-input';
            input.value = latex;
            mathNode.appendChild(input);
            input.focus();
            
            input.addEventListener('blur', function() { finishMathInput(this); });
            input.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    finishMathInput(this);
                }
            });
        }

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('math-node') && !event.target.querySelector('.math-input')) {
                editMathNode(event.target);
            }
        });

        function saveFile() {
            var content = document.getElementById('editor').innerHTML;
            
            // 創建一個臨時的 div 元素來處理內容
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // 處理所有的數學節點
            var mathNodes = tempDiv.querySelectorAll('.math-node');
            mathNodes.forEach(function(node) {
                var latex = node.getAttribute('data-latex');
                if (latex) {
                    // 將 KaTeX 渲染的 HTML 替換為 LaTeX 代碼，確保正確轉義反斜線
                    node.innerHTML = '\\(' + latex.replace(/\\/g, '\\') + '\\)';
                }
            });
            
            // 獲取處理後的 HTML
            var processedContent = tempDiv.innerHTML;

            // 創建包含多個部分的 Blob
            var blob = new Blob([
                '<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><title>保存的文檔</title>',
                '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">',
                '<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"><\/script>',
				'<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>',
                '<script>',
                'document.addEventListener("DOMContentLoaded", function() {',
                '    renderMathInElement(document.body, {',
                '        delimiters: [',
                '            {left: "\(", right: "\)", display: false},',
                '            {left: "\[", right: "\]", display: true}',
                '        ],',
                '        throwOnError: false',
                '    });',
                '});',
                '<\/script>',
                '</head><body>',
                processedContent,
                '</body></html>'
            ], {type: 'text/html'});

            var a = document.createElement('a');
            a.download = 'document.html';
            a.href = URL.createObjectURL(blob);
            a.click();
        }
		
        // Ctrl+M 快捷鍵
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'm') {
                e.preventDefault();
                var selection = window.getSelection();
                var range = selection.getRangeAt(0);
                var node = range.startContainer;

                // 檢查游標是否在數學物件前
                if (node.nodeType === Node.TEXT_NODE && node.nextSibling && node.nextSibling.classList.contains('math-node')) {
                    editMathNode(node.nextSibling);
                } else if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('math-node')) {
                    editMathNode(node);
                } else {
                    insertMathEquation();
                }
            }
        });
        // 數學編輯器相關函數
        let useParentheses = true;
        
        function toggleDelimiter() {
            useParentheses = !useParentheses;
            const button = document.getElementById('toggleDelimiterButton');
            button.textContent = useParentheses ? "使用 \\( \\)" : "使用 $ $";
            button.style.backgroundColor = useParentheses ? "#ccffcc" : "#ffcccc";
        }
        
	       document.getElementById('latexInput').addEventListener('input', updatePreview);
	       document.getElementById('latexInput').addEventListener('scroll', syncScroll);
	       document.getElementById('preview').addEventListener('scroll', syncScroll);
	       document.getElementById('latexInput').addEventListener('keydown', handleKeyDown);
		   document.addEventListener('DOMContentLoaded', function() {
			document.getElementById('convertAllDelimitersButton').textContent = "全部轉換為 \\( \\)";
			});
	           let isSyncEnabled = true;
	   
function syncScroll(event) {
    if (!isSyncEnabled) return;
    
    const latexInput = document.getElementById('latexInput');
    const preview = document.getElementById('preview');
    
    if (!latexInput || !preview) return;
    
    if (event.target.id === 'latexInput') {
        preview.scrollTop = latexInput.scrollTop;
    } else {
        latexInput.scrollTop = preview.scrollTop;
    }
}
	   
	           function toggleSync() {
	               isSyncEnabled = !isSyncEnabled;
	               const button = document.getElementById('toggleSyncButton');
	               if (isSyncEnabled) {
	                   button.textContent = '同步捲動：開';
	                   button.style.backgroundColor = '#ccffcc';
	               } else {
	                   button.textContent = '同步捲動：關';
	                   button.style.backgroundColor = '#ffcccc';
	               }
	           }
	       function handleKeyDown(event) {
	           if (event.key === 'Enter') {
	               event.preventDefault();
	               const textarea = document.getElementById('latexInput');
	               const start = textarea.selectionStart;
	               const end = textarea.selectionEnd;
	               const before = textarea.value.substring(0, start);
	               const after = textarea.value.substring(end, textarea.value.length);
	               textarea.value = before + '\n' + after;
	               textarea.selectionStart = textarea.selectionEnd = start + 1;
	               insertNewLineInMathML();
	               updatePreview();
	           }
	       }

	       function insertMathBrackets(type) {
	           const text = type === '$' ? '$$' : '\\(\\)';
	           insertText(text, type === '$' ? 1 : 2);
	           document.getElementById('latexInput').focus();
	       }
		   
	       function formatOptions() {
	           const textarea = document.getElementById('latexInput');
	           let text = textarea.value;
	           
	           // 將制表符（Tab）和全形空格轉換為半形空格，並將多個連續空格轉換為單個空格
	           text = text.replace(/\t/g, " ").replace(/　/g, " ").replace(/ {2,}/g, " ").replace(/（/g, '(').replace(/）/g, ')');
	           
	           // 分割文本為段落
	           let paragraphs = text.split(/\n\s*/);
	           
	           // 處理每個段落
	           paragraphs = paragraphs.map((paragraph, index) => {
	               // 檢查這個段落是否包含選項
	               if (/\([A-Z]\)/.test(paragraph)) {
	                   // 分割並格式化選項
	                   let options = paragraph.split(/(?=\([A-D]\))/);
	                   options = options.map(option => option.trim().replace(/^\(([A-D])\)\s*/, "($1) "));
	                   // 在選項段落後添加一個換行符
	                   return options.join('\n') + '\n';
	               }
	               // 對於非選項段落，在它前面添加一個換行符
	               return paragraph;
	           });
	           
	           // 重新組合文本，並在每個段落之間添加一個空行
	           text = paragraphs.join('\n');
	           
	           // 移除選項間的空行，但保留最後一個選項與下一段之間的空行
	           text = text.replace(/(\([A-D]\)\s[^\n]*)(\n\s*\n(?=\([A-D]\)))/g, '$1\n');
	           
	           textarea.value = text.trim();
	           updatePreview();
	       }

	       function replaceText() {
			   const textarea = document.getElementById('latexInput');
			   
			   // 使用 prompt 獲取要查找的文本
			   const findText = prompt("請輸入要查找的文本：");
			   if (findText === null || findText === '') {
				   alert('請輸入要查找的文本');
				   return;
			   }
			   
			   // 使用 prompt 獲取要替換的文本
			   const replaceText = prompt("請輸入要替換的文本：");
			   if (replaceText === null) {
				   return; // 用戶取消了操作
			   }
			   
			   const text = textarea.value;
			   const newText = text.replace(new RegExp(escapeRegExp(findText), 'g'), replaceText);
			   
			   textarea.value = newText;
			   updatePreview();
			   }
			   
			   // 用於轉義正則表達式中的特殊字符

			   function escapeRegExp(string) {
				   return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
			   }


			function toggleDelimiter() {
				useParentheses = !useParentheses;
				const toggleButton = document.getElementById('toggleDelimiterButton');
				const convertButton = document.getElementById('convertAllDelimitersButton');
				if (useParentheses) {
					toggleButton.textContent = "使用 \\( \\)";
					toggleButton.style.backgroundColor = "#ccffcc";  // 淺綠色
					convertButton.textContent = "全部轉換為 \\( \\)";
				} else {
					toggleButton.textContent = "使用 $ $";
					toggleButton.style.backgroundColor = "#ffcccc";  // 淺紅色
					convertButton.textContent = "全部轉換為 $ $";
				}
				updateAllButtons();
			}

			function updateAllButtons() {
				const buttons = document.querySelectorAll('button[onclick^="insertMath"]');
				buttons.forEach(button => {
					const originalOnclick = button.getAttribute('onclick');
					const mathContent = originalOnclick.match(/insertMath\('(.+)'\)/)[1];
					button.setAttribute('onclick', `insertMath('${mathContent}')`);
				});
			}

			function convertAllDelimiters() {
				const textarea = document.getElementById('latexInput');
				let text = textarea.value;
				
				const targetDelimiters = useParentheses ? ['\\(', '\\)'] : ['$', '$'];

				// 定義轉換函數
				function convertDelimiters(text, fromStart, fromEnd, toStart, toEnd) {
					let result = '';
					let insideMath = false;
					let depth = 0;
					let mathContent = '';

					for (let i = 0; i < text.length; i++) {
						if (text.startsWith(fromStart, i) && (!insideMath || depth > 0)) {
							if (insideMath) {
								mathContent += fromStart;
								depth++;
							} else {
								result += toStart;
								insideMath = true;
							}
							i += fromStart.length - 1;
						} else if (text.startsWith(fromEnd, i) && insideMath) {
							if (depth > 0) {
								mathContent += fromEnd;
								depth--;
							} else {
								result += mathContent + toEnd;
								mathContent = '';
								insideMath = false;
							}
							i += fromEnd.length - 1;
						} else if (insideMath) {
							mathContent += text[i];
						} else {
							result += text[i];
						}
					}

					// 處理未閉合的數學環境
					if (insideMath) {
						result += fromStart + mathContent;
					}

					return result;
				}

				// 轉換所有分隔符
				text = convertDelimiters(text, '$', '$', targetDelimiters[0], targetDelimiters[1]);
				text = convertDelimiters(text, '\\(', '\\)', targetDelimiters[0], targetDelimiters[1]);
				text = convertDelimiters(text, '\\[', '\\]', targetDelimiters[0], targetDelimiters[1]);

				textarea.value = text;
				updatePreview();
			}
		
			function insertMathDelimiters() {
				const delimiters = useParentheses ? ['\\(', '\\)'] : ['$', '$'];
				insertText(delimiters[0] + delimiters[1], delimiters[0].length);
				document.getElementById('latexInput').focus();
			}
			
			function initMathEditor() {
				const latexInput = document.getElementById('latexInput');
				const preview = document.getElementById('preview');
				
				// 添加事件監聽器
				if(latexInput) {
					latexInput.addEventListener('input', updatePreview);
					latexInput.addEventListener('scroll', syncScroll);
				}
				
				if(preview) {
					preview.addEventListener('scroll', syncScroll);
				}
			}
			
			function insertMath(math) {
				const textarea = document.getElementById('latexInput');
				const start = textarea.selectionStart;
				const end = textarea.selectionEnd;
				const value = textarea.value;
				
				function isInMathEnvironment(pos) {
					const beforeCursor = value.slice(0, pos);
					const dollarPairs = (beforeCursor.match(/\$/g) || []).length;
					const bracketPairs = (beforeCursor.match(/\\\(/g) || []).length - (beforeCursor.match(/\\\)/g) || []).length;
					return (dollarPairs % 2 !== 0) || (bracketPairs > 0);
				}

				let newText, cursorPosition;
				const delimiters = useParentheses ? ['\\(', '\\)'] : ['$', '$'];

				if (isInMathEnvironment(start)) {
					newText = value.slice(0, start) + math + value.slice(end);
					cursorPosition = start + math.length;
				} else {
					newText = value.slice(0, start) + delimiters[0] + math + delimiters[1] + value.slice(end);
					cursorPosition = start + delimiters[0].length + math.length;
				}

				const braceIndex = math.indexOf('{}');
				if (braceIndex !== -1) {
					cursorPosition = (isInMathEnvironment(start) ? start : start + delimiters[0].length) + braceIndex + 1;
				}

				textarea.value = newText;
				textarea.selectionStart = textarea.selectionEnd = cursorPosition;
				textarea.focus();
				updatePreview();
			}

		   function insertTrigFunction() {
				const select = document.getElementById('select-trig');
				const value = select.value;
				if (value) {
					insertMath(value + ' ');  // 使用 insertMath 來插入三角函數
					select.value = "";  // 重置選擇
				}
			}
	       
	       function insertGreekLetter() {
	           const select = document.getElementById('select-letter');
	           const value = select.value;
	           if (value) {
	               insertMath(value + ' ');  // 使用 insertMath 來插入希臘字母
	               select.value = "";
	           }
	       }
 		   function insertSymbols() {
           const select = document.getElementById('set-symbols');
           const value = select.value;
           if (value) {
               insertMath(value + ' ');  // 使用 insertMath 來插入希臘字母
               select.value = "";
           }
       }

	   

	       function insertText(text, cursorOffset) {
	           const textarea = document.getElementById('latexInput');
	           const start = textarea.selectionStart;
	           const end = textarea.selectionEnd;
	           const before = textarea.value.substring(0, start);
	           const after = textarea.value.substring(end, textarea.value.length);
	           textarea.value = before + text + after;
	           
	           // 如果文本包含 {}, 將游標放在 {} 中間
	           const braceIndex = text.indexOf('{}');
	           if (braceIndex !== -1) {
	               textarea.selectionStart = textarea.selectionEnd = start + braceIndex + 1;
	           } else {
	               textarea.selectionStart = textarea.selectionEnd = start + cursorOffset;
	           }
	           
	           textarea.focus();
	           updatePreview();
	       }

	       function insertNewLineInMathML() {
	           const latexInput = document.getElementById('latexInput').value;
	           const mathmlOutput = document.getElementById('mathmlOutput');
	           const lines = latexInput.split('\n');
	           let mathmlContent = '';
	           for (let i = 0; i < lines.length; i++) {
	               mathmlContent += lines[i] + '<br>\n';
	           }
	           mathmlOutput.value = mathmlContent;
	       }

		
function updatePreview() {
    const latex = document.getElementById('latexInput').value;
    const preview = document.getElementById('preview');
    
    if (!preview) return;
    
    try {
        // 將所有數學式轉換為 \(...\) 格式
        let wrappedLatex = latex
            .replace(/(\$)(?!\$)(.+?)(?<!\$)(\$)/g, '\\($2\\)')
            .replace(/\\\[(.*?)\\\]/g, '\\($1\\)');
        
        preview.innerHTML = wrappedLatex;
        
        // 使用 MathJax 重新渲染
        if (window.MathJax) {
            MathJax.typesetPromise([preview]).catch(err => {
                console.error('MathJax error:', err);
            });
        }
    } catch (error) {
        console.error('Preview update error:', error);
    }
}

	       function formatXML(xml) {
	           // 格式化 XML 以便更好地顯示
	           const PADDING = '  ';
	           const reg = /(>)(<)(\/*)/g;
	           let pad = 0;
	           let formatted = '';
	           xml = xml.replace(reg, '$1\r\n$2$3');
	           xml.split('\r\n').forEach((node, index) => {
	               let indent = 0;
	               if (node.match(/.+<\/\w[^>]*>$/)) {
	                   indent = 0;
	               } else if (node.match(/^<\/\w/)) {
	                   if (pad != 0) {
	                       pad -= 1;
	                   }
	               } else if (node.match(/^<\w([^>]*[^\/])?>.*$/)) {
	                   indent = 1;
	               } else {
	                   indent = 0;
	               }

	               let padding = '';
	               for (let i = 0; i < pad; i++) {
	                   padding += PADDING;
	               }

	               formatted += padding + node + '\r\n';
	               pad += indent;
	           });

	           return formatted;
	       }

	       function saveLatexInput() {
	           const latexInput = document.getElementById('latexInput').value;
	           const blob = new Blob([latexInput], { type: 'text/plain;charset=utf-8' });
	           const link = document.createElement('a');
	           link.href = URL.createObjectURL(blob);
	           link.download = 'latex_input.txt';
	           document.body.appendChild(link);
	           link.click();
	           document.body.removeChild(link);
	       }

	       function saveMathMLOutput() {
	           const mathmlOutput = document.getElementById('mathmlOutput').value;
	           const blob = new Blob([mathmlOutput], { type: 'text/html;charset=utf-8' });
	           const link = document.createElement('a');
	           link.href = URL.createObjectURL(blob);
	           link.download = 'mathml_output.html';
	           document.body.appendChild(link);
	           link.click();
	           document.body.removeChild(link);
	       }

	       function openFile(event) {
	           const input = event.target;
	           const reader = new FileReader();
	           reader.onload = function() {
	               const text = reader.result;
	               document.getElementById('latexInput').value = text;
	               updatePreview();
	           };
	           reader.readAsText(input.files[0]);
	       }
		   
		function jumpToNextBraceOrLatex(forward = true) {
			const textarea = document.getElementById('latexInput');
			const text = textarea.value;
			const cursorPosition = textarea.selectionStart;

			// 正則表達式匹配 {} 和 LaTeX 分隔符
			const regex = /\{|\}|\\\(|\\\)|\$\$/g;
			let match;
			let nextPosition = cursorPosition;

			if (forward) {
				// 向前搜索
				regex.lastIndex = cursorPosition;
				while ((match = regex.exec(text)) !== null) {
					if (match.index > cursorPosition) {
						nextPosition = match.index + match[0].length;
						break;
					}
				}
			} else {
				// 向後搜索
				const reverseText = text.split('').reverse().join('');
				const reverseRegex = /\}|\{|\)\\\(|\\\|\$\$/g;
				const reverseCursorPosition = text.length - cursorPosition;
				reverseRegex.lastIndex = reverseCursorPosition;
				while ((match = reverseRegex.exec(reverseText)) !== null) {
					if (match.index > reverseCursorPosition) {
						nextPosition = text.length - (match.index + match[0].length);
						break;
					}
				}
			}

			// 設置新的光標位置
			textarea.setSelectionRange(nextPosition, nextPosition);
			textarea.focus();
		}
		
    document.getElementById('latexInput').addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'm') {
            e.preventDefault(); // 防止默认行为
            wrapMathExpression(this, false);
        }
    });
    
    document.getElementById('latexInput').addEventListener('keydown', function(e) {
        if (e.altKey && e.key === 'm') {
            e.preventDefault(); // 防止默認行為
            wrapMathExpression(this, true);
        }
    });
    
    function wrapMathExpression(textarea, moveCursorInside) {
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;
        // 找到當前行的開始和結束
        const lineStart = value.lastIndexOf('\n', start - 1) + 1;
        const lineEnd = value.indexOf('\n', end);
        const currentLine = value.substring(lineStart, lineEnd === -1 ? value.length : lineEnd);
        // 在當前行內找到包裹結束的位置
        const cursorPosInLine = start - lineStart;
        let wrapEndIndex = cursorPosInLine;
        const chineseRegex = /[\u4e00-\u9fa5]/; // 匹配中文字符
        const fullWidthPuncRegex = /[\uFF00-\uFFEF]/; // 匹配全形標點
        while (wrapEndIndex < currentLine.length) {
            const char = currentLine[wrapEndIndex];
            if (char === ' ' || chineseRegex.test(char) || fullWidthPuncRegex.test(char)) {
                break;
            }
            wrapEndIndex++;
        }
        // 獲取要包裹的文本
        const textToWrap = currentLine.substring(cursorPosInLine, wrapEndIndex);
        // 根據當前設置選擇分隔符
        const delimiters = useParentheses ? ['\\(', '\\)'] : ['$', '$'];
        // 創建新的行文本
        const newLineText = currentLine.substring(0, cursorPosInLine) + 
                            delimiters[0] + textToWrap + delimiters[1] + 
                            currentLine.substring(wrapEndIndex);
        // 更新整個文本區域的值
        textarea.value = value.substring(0, lineStart) + newLineText + value.substring(lineEnd === -1 ? value.length : lineEnd);
        
        let newCursorPos;
        if (moveCursorInside) {
            // 如果是 alt + M，將游標移動到分隔符內部
            newCursorPos = lineStart + cursorPosInLine + delimiters[0].length;
        } else {
            // 如果是 ctrl + M，保持原有邏輯
            const validStartRegex = /[a-zA-Z0-9\\]/;
            newCursorPos = lineStart + cursorPosInLine + delimiters[0].length + textToWrap.length + delimiters[1].length;
            let foundValid = false;
            while (newCursorPos < value.length) {
                if (value[newCursorPos] === '\n') {
                    // 如果遇到換行符，停在下一行開頭
                    newCursorPos++;
                    break;
                }
                if (validStartRegex.test(value[newCursorPos])) {
                    foundValid = true;
                    break;
                }
                newCursorPos++;
            }
            // 如果沒找到有效字符，則保持在包裹符號後
            if (!foundValid) {
                newCursorPos = lineStart + cursorPosInLine + delimiters[0].length + textToWrap.length + delimiters[1].length;
            }
        }
        
        // 更新光標位置
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        // 更新預覽
        updatePreview();
    }


		
		function convertLatexTableToHTML(latexTable) {
			// 移除 tabular 环境的开始和结束标记
			latexTable = latexTable.replace(/\\begin{tabular}.*?\n/, '')
								   .replace(/\\end{tabular}/, '');

			let html = '<table border="1">';
			let rows = latexTable.split('\\\\').filter(row => row.trim() !== '');
			let inHeader = false;
			let isFirstRow = true;

			rows.forEach((row, index) => {
				row = row.trim();

				if (row.includes('\\hline')) {
					if (!isFirstRow) {
						html += inHeader ? '</th></tr>' : '</td></tr>';
					}
					inHeader = false;
					isFirstRow = false;
					row = row.replace('\\hline', '');
				}

				if (row !== '') {
					if (row.includes('\\multicolumn')) {
						html += '<tr><th colspan="2">';
						inHeader = true;
						row = row.replace(/\\multicolumn{\d+}{[^}]+}{([^}]+)}/, '$1');
					} else if (!inHeader && !isFirstRow) {
						html += '<tr>';
					}

					let cells = row.split('&');
					cells.forEach((cell, cellIndex) => {
						cell = cell.trim()
							.replace(/\\\w+{([^}]+)}/, '$1') // 处理 \textbf 等命令
							.replace(/(\$[^\$]+\$|\\\([^\)]+\\\))/g, match => {
								// 将数学式包裹在 \(...\) 中
								return '\\(' + match.replace(/^\$|\$$|\\\(|\\\)$/g, '') + '\\)';
							})
							.replace(/\\%/g, '%') // 处理百分号
							.replace(/\\\s/g, ' '); // 处理 LaTeX 空格
						
						if (inHeader) {
							html += (cellIndex === 0 && !isFirstRow ? '<th>' : '') + cell;
						} else {
							html += `<td>${cell}</td>`;
						}
					});

					isFirstRow = false;
				}
			});

			// 确保最后一行正确闭合
			if (!isFirstRow) {
				html += inHeader ? '</th></tr>' : '</td></tr>';
			}

			html += '</table>';
			return html;
		}

		function convertMarkdownToHTML() {
			const textarea = document.getElementById('latexInput');
			let text = textarea.value;

			// 首先替換 \(\qquad\)
			text = text.replace(/\\qquad/g, "----");

			// 轉換 LaTeX 表格
			text = text.replace(/\\begin{tabular}[\s\S]*?\\end{tabular}/g, match => {
				return convertLatexTableToHTML(match);
			});

			// 轉換圖片
			text = text.replace(/!\[([^\]]*)\]\(([^\)]+)\)/g, '<img src="$2" alt="Mathpix Image">');

			// 轉換表格
			let hasTable = false;
			text = text.replace(/(\|(.+)\|[\r\n]*)+/g, function(match) {
				hasTable = true;
				let rows = match.trim().split('\n');
				let tableHTML = '<table>';
				
				rows.forEach((row, index) => {
					const cells = row.split('|').filter(cell => cell.trim() !== '');
					const isHeader = cells.some(cell => cell.includes('---'));
					
					if (!isHeader) {
						const tag = index === 0 ? 'th' : 'td';
						const cellContent = cells.map(cell => `<${tag}>${cell.trim()}</${tag}>`).join('');
						tableHTML += `<tr>${cellContent}</tr>`;
					}
				});
				
				tableHTML += '</table>';
				return tableHTML;
			});

			// 如果沒有表格，不要添加 table 標籤
			if (!hasTable) {
				text = text.replace(/<table>(.*)<\/table>/s, '$1');
			}

			// 轉換粗體
			text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

			// 轉換斜體
			text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

			// 轉換標題
			text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
			text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
			text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');

			// 轉換列表
			text = text.replace(/^\s*\*\s(.*)$/gm, '<li>$1</li>');
			text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

			// 轉換連結
			text = text.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2">$1</a>');

			// 使用正則表達式替換 \section*{ } 和 \title{ }
			text = text.replace(/\\section\*\{(.*?)\}/g, '$1');
			text = text.replace(/\\title\s*\{([\s\S]*?)\}/g, '$1').trim();

      // 使用正則表達式替換 / /
      text = text.replace(/(\w+)\s*\/\s*\/\s*(\w+)/g, '$1 \\parallel $2');

			textarea.value = text;
			updatePreview();
		}

		function clearAll() {
        // 清空 latexInput
        document.getElementById('latexInput').value = '';
    
        // 清空 preview
        document.getElementById('preview').innerHTML = '';
    
        // 如果您使用 MathJax 或類似的庫來渲染數學公式，可能需要重新渲染
        if (typeof MathJax !== 'undefined') {
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, "preview"]);
        }
    
        // 如果您有其他需要清空或重置的元素，也可以在這裡處理
    }
		
		document.addEventListener('keydown', function(e) {
			const textarea = document.getElementById('latexInput');
			if (document.activeElement === textarea) {
				if (e.altKey && e.key === 'ArrowRight') {
					e.preventDefault();
					jumpToNextBraceOrLatex(true);
				} else if (e.altKey && e.key === 'ArrowLeft') {
					e.preventDefault();
					jumpToNextBraceOrLatex(false);
				}
			}
		});		
		
				   function savePreviewAsHTML() {
				const clonedDoc = document.cloneNode(true);

				// 保留 preview div
				const previewDiv = clonedDoc.getElementById('preview');

				// 清空 body，只保留 preview div
				clonedDoc.body.innerHTML = '';
				clonedDoc.body.appendChild(previewDiv);

				// 移除所有不必要的元素
				const elementsToRemove = clonedDoc.querySelectorAll('script, link, style, meta:not([charset]), button, textarea');
				elementsToRemove.forEach(el => el.remove());

				// 確保有 charset meta 標籤
				if (!clonedDoc.querySelector('meta[charset]')) {
					const meta = clonedDoc.createElement('meta');
					meta.setAttribute('charset', 'UTF-8');
					clonedDoc.head.appendChild(meta);
				}

				// 修改標題
				const titleElement = clonedDoc.querySelector('title');
				if (titleElement) {
					titleElement.textContent = 'LaTeX Preview';
				} else {
					const newTitle = clonedDoc.createElement('title');
					newTitle.textContent = 'LaTeX Preview';
					clonedDoc.head.appendChild(newTitle);
				}

				// 添加 MathJax 腳本
				const mathJaxScript = clonedDoc.createElement('script');
				mathJaxScript.src = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js";
				clonedDoc.head.appendChild(mathJaxScript);

				// 添加 MathJax 配置
				const mathJaxConfig = clonedDoc.createElement('script');
				mathJaxConfig.textContent = `
					window.MathJax = {
						tex: {
							inlineMath: [['$', '$'], ['\\\\(', '\\\\)']]
						}
					};
				`;
				clonedDoc.head.insertBefore(mathJaxConfig, mathJaxScript);

				const htmlContent = clonedDoc.documentElement.outerHTML;

				const blob = new Blob([htmlContent], { type: 'text/html' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'latex_preview.html';
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
			}

			document.querySelector('#savePreviewButton').addEventListener('click', savePreviewAsHTML);

		function delspace() {
			const input = document.getElementById('latexInput');
			let text = input.value;
			
			// 1. 移除 \right 和 \left
			text = text.replace(/\\(right|left)(?![a-zA-Z])/g, '');
			
			// 2. 把 \mathrm{x} 變成 x (對任何單個字符)
			text = text.replace(/\\mathrm\{([a-zA-Z0-9])\}/g, '$1');
			
			// 3. 移除數字後面接 x 或 y 的空格
			text = text.replace(/(\d)\s+([xy])/g, '$1$2');
			
			// 原本的大寫字母間空格處理
			text = text.replace(/\\\((.*?)\\\)/g, function(match, content) {
				// 處理大寫字母之間的空格
				const processed = content.replace(/([A-Z])\s+(?=[A-Z])/g, '$1');
				return '\\(' + processed + '\\)';
			});
			
			input.value = text;
			// 觸發 change 事件
			input.dispatchEvent(new Event('change'));
		}
        
        // 模態框控制函數
        function openMathEditorModal() {
            document.getElementById('mathEditorModal').style.display = 'block';
        }
        
        function closeMathEditorModal() {
            document.getElementById('mathEditorModal').style.display = 'none';
        }
        
 document.addEventListener('DOMContentLoaded', function() {
    initMathEditor();
    
    // 添加模態框關閉事件
    window.onclick = function(event) {
        const mathModal = document.getElementById('mathEditorModal');
        if (event.target == mathModal) {
            closeMathEditorModal();
        }
    };
	
	    // 為數學編輯器模態框添加事件監聽器
    const mathModal = document.getElementById('mathEditorModal');
    const closeBtn = mathModal.querySelector('.close');
    
    // 關閉按鈕事件
    if (closeBtn) {
        closeBtn.onclick = closeMathEditorModal;
    }
    
    // 點擊模態框外部關閉
    window.onclick = function(event) {
        if (event.target === mathModal) {
            closeMathEditorModal();
        }
    };
    
    // 初始化預覽更新
    const latexInput = document.getElementById('latexInput');
    if (latexInput) {
        latexInput.addEventListener('input', updatePreview);
    }
	
});
    </script>
</body>
</html>