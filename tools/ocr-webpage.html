<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上 OCR (tesseract.js)</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js'></script>
    <style>
        #imageContainer {
            margin-top: 20px;
            text-align: center;
        }
        #uploadedImage {
            max-width: 100%;
            max-height: 400px;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            min-height: 100px;
        }
        #status {
            margin-top: 10px;
            font-style: italic;
        }
        #copyButton, #resetButton {
            display: none;
        }
    </style>
</head>
<body>
    <h1>線上 OCR (tesseract.js)</h1>
    <p>上傳一張包含文字的圖片或使用 Ctrl+V 從剪貼簿貼上，系統將自動識別圖片中的文字。</p>
    <input type="file" id="imageUpload" accept="image/*">
    <div id="imageContainer">
        <img id="uploadedImage" alt="上傳的圖片" style="display: none;">
    </div>
    <div id="status"></div>
    <div id="result"></div>
    <button id="copyButton">複製辨識結果</button>
    <button id="resetButton">重新辨識</button>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const status = document.getElementById('status');
        const result = document.getElementById('result');
        const uploadedImage = document.getElementById('uploadedImage');
        const copyButton = document.getElementById('copyButton');
        const resetButton = document.getElementById('resetButton');

        function removeSpacesBetweenChinese(text) {
            // 使用更嚴格的正則表達式來匹配中文字符
            return text.replace(/([\\u4e00-\\u9fa5]) +(?=[\\u4e00-\\u9fa5])/g, '$1');
        }

        function processImage(imageFile) {
            status.textContent = '正在處理圖片，請稍候...';
            result.textContent = '';
            uploadedImage.src = URL.createObjectURL(imageFile);
            uploadedImage.style.display = 'block';
            copyButton.style.display = 'none';
            resetButton.style.display = 'none';

            Tesseract.recognize(imageFile, 'chi_tra+eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        status.textContent = `識別進度：${Math.round(m.progress * 100)}%`;
                    }
                }
            }).then(({ data: { text } }) => {
                status.textContent = '識別完成！';
                const optimizedText = removeSpacesBetweenChinese(text);
                result.textContent = optimizedText;
                copyButton.style.display = 'inline-block';
                resetButton.style.display = 'inline-block';
            }).catch(error => {
                status.textContent = '識別過程中發生錯誤。';
                console.error(error);
            });
        }

        function resetOCR() {
            uploadedImage.style.display = 'none';
            result.textContent = '';
            status.textContent = '';
            copyButton.style.display = 'none';
            resetButton.style.display = 'none';
            imageUpload.value = ''; // 清除文件輸入
        }

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                processImage(file);
            }
        });

        document.addEventListener('paste', (event) => {
            const items = event.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    processImage(blob);
                    break;
                }
            }
        });

        copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(result.textContent).then(() => {
                alert('辨識結果已複製到剪貼簿');
            }).catch(err => {
                console.error('複製失敗:', err);
                alert('複製失敗，請手動複製文字');
            });
        });

        resetButton.addEventListener('click', resetOCR);
    </script>
</body>
</html>
