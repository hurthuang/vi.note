<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>長條圖生成器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        #dataInput { margin-bottom: 20px; }
        input, button { margin: 5px; padding: 5px; }
        #chartContainer { margin-top: 20px; }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <h1>長條圖生成器</h1>
    
    <div id="dataInput">
        <h2>輸入數據</h2>
        <form id="dataForm">
            <div id="inputFields">
                <div>
                    <input type="text" placeholder="類別" required>
                    <input type="number" placeholder="數值" required>
                </div>
            </div>
            <button type="button" id="addField">新增欄位</button>
            <button type="submit">生成圖表</button>
        </form>
    </div>

    <div id="chartContainer" aria-label="無障礙條形圖" role="img"></div>

    <script>
        document.getElementById('addField').addEventListener('click', function() {
            const inputFields = document.getElementById('inputFields');
            const newField = document.createElement('div');
            newField.innerHTML = `
                <input type="text" placeholder="類別" required>
                <input type="number" placeholder="數值" required>
            `;
            inputFields.appendChild(newField);
        });

        document.getElementById('dataForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const inputs = document.querySelectorAll('#inputFields input');
            const data = [];
            for (let i = 0; i < inputs.length; i += 2) {
                const category = inputs[i].value;
                const value = parseFloat(inputs[i + 1].value);
                if (category && !isNaN(value)) {
                    data.push({ category, value });
                }
            }
            createChart(data);
        });

        function createChart(data) {
            d3.select("#chartContainer").html(""); // 清除舊圖表

            const margin = { top: 20, right: 20, bottom: 30, left: 40 };
            const width = 400 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select("#chartContainer")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .range([height, 0]);

            x.domain(data.map(d => d.category));
            y.domain([0, d3.max(data, d => d.value)]);

            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.category))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d.value))
                .attr("height", d => height - y(d.value))
                .attr("fill", "steelblue")
                .attr("role", "graphics-symbol")
                .attr("aria-roledescription", "條形")
                .attr("aria-label", d => `${d.category}: ${d.value}`);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .attr("aria-hidden", "true");

            svg.append("g")
                .call(d3.axisLeft(y))
                .attr("aria-hidden", "true");

            svg.append("title")
                .text("使用者自定義的無障礙條形圖");

            // 創建數據表格供屏幕閱讀器使用
            const table = d3.select("#chartContainer")
                .append("table")
                .attr("class", "sr-only")
                .attr("summary", "條形圖數據表格形式");

            const thead = table.append("thead");
            const tbody = table.append("tbody");

            thead.append("tr")
                .selectAll("th")
                .data(["類別", "數值"])
                .enter()
                .append("th")
                .text(d => d);

            const rows = tbody.selectAll("tr")
                .data(data)
                .enter()
                .append("tr");

            rows.append("td")
                .text(d => d.category);

            rows.append("td")
                .text(d => d.value);

        }
    </script>
</body>
</html>
