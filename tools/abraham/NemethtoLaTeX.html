<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemeth to LaTeX Converter with Braille Input</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="abraham.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { display: flex; gap: 20px; }
        .column { flex: 1; }
        textarea { width: 100%; height: 200px; font-size: 16px; }
        #preview, #output { border: 1px solid #ddd; min-height: 200px; white-space: pre-wrap; }
        #output { font-family: monospace; }
        #mode { font-weight: bold; }
        #fontSizeControl { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Nemeth to LaTeX Converter with Braille Input</h1>
    
    <div>當前模式：<span id="mode">一般輸入法</span>(按 Ctrl + B 切換輸入模式)
    
    <div class="container">
        <div class="column">
            <h2>Input (Text with Braille)</h2>
            <textarea id="input" style="height: 200px;" placeholder="Enter text or use Braille input (fdsjkl keys)..." oninput="convert()"></textarea>
        </div>
        <div class="column">
            <h2>Preview</h2>
            <div id="preview" style="height: 200px; overflow-y: auto;"></div>
        </div>
    </div>
    <h2>LaTeX Output</h2>
    <pre id="output" style="height: 200px; overflow-y: auto;"></pre>
    
    <div>
        <button onclick="copyToClipboard()">複製到剪貼簿</button>
        <button onclick="saveToFile()">存檔</button>
    </div>

    <script>
        let previousInput = '';
        let previousOutput = [];
        let isBrailleMode = false;
        let fontSize = 16;
        let dots = [0, 0, 0, 0, 0, 0];
        let brailleCode = 0;
        let textarea = document.getElementById('input');

        function isBrailleUnicode(char) {
            return char >= '\u2800' && char <= '\u28FF';
        }

        function convertBrailleToLatex(braille) {
            try {
                const result = Abraham.nemethToLatex(braille);
                if (result.isError) {
                    throw new Error(result.error.message);
                }
                return result.value;
            } catch (error) {
                console.error('Error converting Braille to LaTeX:', error);
                return braille; // Return original Braille if conversion fails
            }
        }

        function convert() {
            const input = document.getElementById('input').value;
            let outputLatex = '';
            let previewHtml = '';
            let currentBraille = '';
            let outputSegments = [];

            function processBraille() {
                if (currentBraille) {
                    const latex = convertBrailleToLatex(currentBraille);
                    outputLatex += '\\(' + latex + '\\)';
                    previewHtml += '<span class="math">\\(' + latex + '\\)</span>';
                    outputSegments.push({ type: 'math', content: latex });
                    currentBraille = '';
                }
            }

            for (let char of input) {
                if (isBrailleUnicode(char)) {
                    currentBraille += char;
                } else {
                    processBraille();
                    outputLatex += char;
                    previewHtml += char;
                    outputSegments.push({ type: 'text', content: char });
                }
            }
            processBraille(); // Process any remaining Braille

            document.getElementById('output').textContent = outputLatex;

            // Only update changed parts in preview
            if (input !== previousInput) {
                const previewElement = document.getElementById('preview');
                for (let i = 0; i < outputSegments.length; i++) {
                    if (i >= previousOutput.length || JSON.stringify(outputSegments[i]) !== JSON.stringify(previousOutput[i])) {
                        if (outputSegments[i].type === 'math') {
                            const span = document.createElement('span');
                            span.className = 'math';
                            span.innerHTML = '\\(' + outputSegments[i].content + '\\)';
                            if (i < previewElement.childNodes.length) {
                                previewElement.replaceChild(span, previewElement.childNodes[i]);
                            } else {
                                previewElement.appendChild(span);
                            }
                            MathJax.typesetPromise([span]).catch((err) => console.log('Typeset failed: ' + err.message));
                        } else {
                            const textNode = document.createTextNode(outputSegments[i].content);
                            if (i < previewElement.childNodes.length) {
                                previewElement.replaceChild(textNode, previewElement.childNodes[i]);
                            } else {
                                previewElement.appendChild(textNode);
                            }
                        }
                    }
                }
                // Remove extra nodes if new output is shorter
                while (previewElement.childNodes.length > outputSegments.length) {
                    previewElement.removeChild(previewElement.lastChild);
                }
                previousInput = input;
                previousOutput = outputSegments;
            }
        }

        function toggleInputMode(e) {
            if (e.ctrlKey && e.key === 'b') {
                isBrailleMode = !isBrailleMode;
                document.getElementById('mode').textContent = isBrailleMode ? '點字輸入法' : '一般輸入法';
                e.preventDefault();
            }
        }

        function keypressFunction(event) {
            if (!isBrailleMode) return true;
            if ((event.keyCode == 37) || (event.keyCode == 39) || (event.keyCode == 8) || (event.keyCode == 9) || (event.keyCode == 46) || (event.keyCode == 13)) {
                return true;
            }
            event.preventDefault();
            return false;
        }

        function keydownFunction(event) {
            if (!isBrailleMode) return true;
            if ((event.keyCode != 37) && (event.keyCode != 39) && (event.keyCode != 8) && (event.keyCode != 9) && (event.keyCode != 46) && (event.keyCode != 13)) {
                if (event.keyCode == 83) {
                    dots[0] = 1;
                    brailleCode = brailleCode | 4;
                } else if (event.keyCode == 68) {
                    dots[1] = 1;
                    brailleCode = brailleCode | 2;
                } else if (event.keyCode == 70) {
                    dots[2] = 1;
                    brailleCode = brailleCode | 1;
                } else if (event.keyCode == 74) {
                    dots[3] = 1;
                    brailleCode = brailleCode | 8;
                } else if (event.keyCode == 75) {
                    dots[4] = 1;
                    brailleCode = brailleCode | 16;
                } else if (event.keyCode == 76) {
                    dots[5] = 1;
                    brailleCode = brailleCode | 32;
                } else if (event.keyCode == 32) {
                    brailleCode = 65;
                    return true;
                }
                return false;
            }
        }

        function keyupFunction(event) {
            if (!isBrailleMode) return true;
            for (i = 0; i < 6; i++) {
                dots[i] = 0;
            }
            if (brailleCode == 0) {
                return false;
            } else {
                if (brailleCode == 65) {
                    brailleCode = 0;
                }
                var sPos = textarea.selectionStart;
                var ePos = textarea.selectionEnd;
                var brl = String.fromCharCode(0x2800 + brailleCode);
                var a = textarea.value;
                var output = a.slice(0, sPos) + brl + a.slice(ePos);
                textarea.value = output;
                setCaretPosition(textarea, sPos + 1);
            }
            brailleCode = 0;
            convert();
            return false;
        }

        function setCaretPosition(ctrl, pos) {
            if (ctrl.setSelectionRange) {
                ctrl.focus();
                ctrl.setSelectionRange(pos, pos);
            } else if (ctrl.createTextRange) {
                var range = ctrl.createTextRange();
                range.collapse(true);
                range.moveEnd('character', pos);
                range.moveStart('character', pos);
                range.select();
            }
        }

        function copyToClipboard() {
            const output = document.getElementById('output');
            navigator.clipboard.writeText(output.textContent)
                .then(() => alert('已複製到剪貼簿'))
                .catch(err => console.error('複製失敗: ', err));
        }

        function saveToFile() {
            const output = document.getElementById('output').textContent;
            const blob = new Blob([output], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'latex_output.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        document.addEventListener('keydown', toggleInputMode);
        textarea.addEventListener('keypress', keypressFunction);
        textarea.addEventListener('keydown', keydownFunction);
        textarea.addEventListener('keyup', keyupFunction);

        // Initial conversion
        convert();
    </script>
</body>
</html>